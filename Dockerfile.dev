FROM --platform=linux/amd64 node:18-bullseye

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
  && apt-get install -y --no-install-recommends git curl ca-certificates default-jre-headless \
  && rm -rf /var/lib/apt/lists/*

# Enable Corepack and pnpm
RUN corepack enable && corepack prepare pnpm@8.15.1 --activate

# Install Firebase CLI globally
RUN npm install -g firebase-tools@13.27.0

WORKDIR /workspace

# Copy lockfiles first for caching
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

RUN pnpm install --frozen-lockfile --store=/pnpm-store

# Create non-root user and use it
RUN useradd -ms /bin/bash devuser
USER devuser

ENV PATH="/home/devuser/.local/bin:${PATH}"

# Keep container running by default
CMD ["tail", "-f", "/dev/null"]
