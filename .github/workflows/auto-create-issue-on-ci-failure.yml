name: Auto-create issue on CI failure

on:
  workflow_run:
    workflows: ["CI — Emulators & Tests"]
    types: [completed]

permissions:
  issues: write
  contents: read

jobs:
  create-issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create deduplicated issue for failing workflow
        uses: actions/github-script@v6
        with:
          script: |
            const run = github.event.workflow_run;
            const workflowName = run.name || github.event.workflow_run.workflow_id;
            const runUrl = run.html_url;
            const runId = run.id;
            const commitSha = run.head_sha;
            const title = `CI failure: ${workflowName} — run ${runId}`;
            const body = `The workflow **${workflowName}** failed.\n\n` +
              `Run: ${runUrl}\n` +
              `Conclusion: ${run.conclusion}\n` +
              `Commit: ${commitSha}\n\n` +
              `Jobs and logs: ${runUrl}`;

            // List open issues labeled ci-failure and check for duplicates
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 100
            });

            const duplicate = issues.data.find(i => (
              i.title === title || i.body.includes(`run ${runId}`) || i.body.includes(workflowName)
            ));

            if (duplicate) {
              core.info(`Found existing issue #${duplicate.number}; skipping creation.`);
              return { issueNumber: duplicate.number };
            }

            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci-failure', 'automated']
            });

            core.info(`Created issue #${newIssue.data.number}`);
            return { issueNumber: newIssue.data.number };
