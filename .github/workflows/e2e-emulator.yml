name: E2E (Emulator)

on:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  e2e:
    name: E2E against Firebase emulators
    runs-on: ubuntu-latest
    env:
      FIREBASE_PROJECT: gosenderr-6773f

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install firebase-tools
        run: npm i -g firebase-tools@latest

      - name: Run Firebase emulators and Playwright E2E
        env:
          CI: 'true'
        run: |
          set -euo pipefail
          echo "Starting emulators and seeding auth user..."
          # write a CI-specific firebase config to avoid default port conflicts
          cat > firebase.ci.json <<'EOF'
          {
            "emulators": {
              "auth": { "host": "127.0.0.1", "port": 9099 },
              "firestore": { "host": "127.0.0.1", "port": 8080 },
              "ui": { "host": "127.0.0.1", "port": 4050 },
              "hub": { "host": "127.0.0.1", "port": 4401 },
              "logging": { "host": "127.0.0.1", "port": 4501 }
            }
          }
          EOF

          # Start emulators in the background and capture logs (omit storage emulator to avoid requiring storage.rules)
          npx firebase emulators:start --config firebase.ci.json --only auth,firestore --project ${FIREBASE_PROJECT} > emulators.log 2>&1 &
          EMU_PID=$!
          echo "Emulators started in background (PID=$EMU_PID). Waiting for Auth and Firestore emulators to be ready..."

          # Persist Vite env vars into apps/marketplace-app/.env so the dev server reads them
          mkdir -p apps/marketplace-app
          cat > apps/marketplace-app/.env <<'EOF'
VITE_FIREBASE_API_KEY=fake-api-key
VITE_FIREBASE_AUTH_DOMAIN=127.0.0.1
VITE_FIREBASE_PROJECT_ID=${FIREBASE_PROJECT}
VITE_FIREBASE_STORAGE_BUCKET=${FIREBASE_PROJECT}.appspot.com
VITE_FIREBASE_APP_ID=1:000:web:fake
VITE_FIREBASE_AUTH_EMULATOR_HOST=127.0.0.1:9099
VITE_FIRESTORE_EMULATOR_HOST=127.0.0.1:8080
NEXT_PUBLIC_MAPBOX_TOKEN=dummy_token
EOF

          # Also export env vars for the current shell (so server/test helpers pick them up)
          export VITE_FIREBASE_API_KEY="fake-api-key"
          export VITE_FIREBASE_AUTH_DOMAIN="127.0.0.1"
          export VITE_FIREBASE_PROJECT_ID="${FIREBASE_PROJECT}"
          export VITE_FIREBASE_STORAGE_BUCKET="${FIREBASE_PROJECT}.appspot.com"
          export VITE_FIREBASE_APP_ID="1:000:web:fake"
          export VITE_FIREBASE_AUTH_EMULATOR_HOST="127.0.0.1:9099"
          export VITE_FIRESTORE_EMULATOR_HOST="127.0.0.1:8080"

          # Set standard env vars too so server-side test helpers pick up emulator host
          export FIREBASE_AUTH_EMULATOR_HOST="127.0.0.1:9099"
          export FIRESTORE_EMULATOR_HOST="127.0.0.1:8080"

          # wait for the auth and firestore emulator endpoints
          npx wait-on --timeout 60000 http://127.0.0.1:9099 || {
            echo "Auth emulator did not become available. Dumping emulator log:"; tail -n +1 emulators.log; kill $EMU_PID || true; exit 1
          }
          npx wait-on --timeout 60000 tcp:127.0.0.1:8080 || {
            echo "Firestore emulator did not become available. Dumping emulator log:"; tail -n +1 emulators.log; kill $EMU_PID || true; exit 1
          }

          echo "Auth emulator is up; seeding vendor user..."
          curl -s -X POST 'http://127.0.0.1:9099/identitytoolkit.googleapis.com/v1/accounts:signUp?key=fake-api-key' -H 'Content-Type: application/json' -d '{"email":"vender@sender.com","password":"admin123","returnSecureToken":true}' || true

          echo "Starting marketplace-app dev server on port 5180"
          pnpm --filter @gosenderr/marketplace-app exec -- vite --port 5180 --strictPort --host 127.0.0.1 > marketplace.log 2>&1 &
          SERVER_PID=$!
          npx wait-on --timeout 60000 http://127.0.0.1:5180 || { echo "Customer app server did not become available. Dumping customer log:"; tail -n +1 customer.log; kill $SERVER_PID || true; tail -n +1 emulators.log; kill $EMU_PID || true; exit 1; }

          echo "Installing Playwright browsers in package context"
          pnpm --filter @gosenderr/marketplace-app exec -- playwright install --with-deps || { echo "playwright install failed"; tail -n +1 customer.log; tail -n +1 emulators.log; kill $SERVER_PID || true; kill $EMU_PID || true; exit 1; }

          echo "Running Playwright tests"
          # run Playwright from the package so the binary resolves correctly
          pnpm --filter @gosenderr/marketplace-app exec -- playwright test tests/e2e --reporter=list || {
            echo "Playwright failed â€” capturing customer and emulator logs"; tail -n +1 customer.log; tail -n +1 emulators.log; kill $SERVER_PID || true; kill $EMU_PID || true; exit 1
          }

          # tests succeeded (or failed above); ensure both the app server and emulator process are terminated
          echo "Tests completed; stopping customer server (PID=$SERVER_PID) and emulators (PID=$EMU_PID)"; kill $SERVER_PID || true; kill $EMU_PID || true
          sleep 1
          tail -n +1 customer.log | sed -n '1,200p'
          tail -n +1 emulators.log | sed -n '1,200p'

          # tests succeeded (or failed above); ensure the emulator process is terminated
          echo "Tests completed; stopping emulators (PID=$EMU_PID)"; kill $EMU_PID || true
          sleep 1
          tail -n +1 emulators.log | sed -n '1,200p'

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            apps/marketplace-app/test-results/**
            apps/marketplace-app/playwright-report/**
            test-results/**

  e2e-preview:
    name: E2E against built preview
    runs-on: ubuntu-latest
    needs: e2e

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build customer app
        run: pnpm --filter @gosenderr/marketplace-app build

      - name: Start preview server
        run: |
          # ensure required env is present for the preview server
          mkdir -p apps/marketplace-app
          cat > apps/marketplace-app/.env <<'EOF'
VITE_FIREBASE_API_KEY=fake-api-key
VITE_FIREBASE_AUTH_DOMAIN=127.0.0.1
VITE_FIREBASE_PROJECT_ID=${FIREBASE_PROJECT}
VITE_FIREBASE_APP_ID=1:000:web:fake
NEXT_PUBLIC_MAPBOX_TOKEN=dummy_token
EOF

          # serve the built app on the same base port as Playwright expects
          pnpm --filter @gosenderr/marketplace-app exec -- vite preview --port 5180 --strictPort --host 127.0.0.1 &
          npx wait-on http://localhost:5180
        env:
          CI: 'true'

      - name: Run Playwright E2E against preview
        env:
          CI: 'true'
        run: |
          pnpm --filter @gosenderr/marketplace-app exec -- playwright install --with-deps
          pnpm --filter @gosenderr/marketplace-app exec -- playwright test tests/e2e --reporter=list --config=playwright.config.ts

      - name: Upload preview test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-preview-artifacts
          path: |
            apps/marketplace-app/test-results/**
            apps/marketplace-app/playwright-report/**
            test-results/**
