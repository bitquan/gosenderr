name: E2E (Emulator)

on:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  e2e:
    name: E2E against Firebase emulators
    runs-on: ubuntu-latest
    env:
      FIREBASE_PROJECT: gosenderr-6773f

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install firebase-tools
        run: npm i -g firebase-tools@latest

      - name: Run Firebase emulators and Playwright E2E
        env:
          CI: 'true'
        run: |
          set -euo pipefail
          echo "Starting emulators and seeding auth user..."
          # write a CI-specific firebase config to avoid default port conflicts
          cat > firebase.ci.json <<'EOF'
          {
            "emulators": {
              "auth": { "host": "127.0.0.1", "port": 9095 },
              "firestore": { "host": "127.0.0.1", "port": 8085 },
              "storage": { "host": "127.0.0.1", "port": 9199 },
              "ui": { "host": "127.0.0.1", "port": 4050 },
              "hub": { "host": "127.0.0.1", "port": 4401 },
              "logging": { "host": "127.0.0.1", "port": 4501 }
            }
          }
          EOF

          # Start emulators in the background and capture logs
          npx firebase emulators:start --config firebase.ci.json --only auth,firestore,storage --project ${FIREBASE_PROJECT} > emulators.log 2>&1 &
          EMU_PID=$!
          echo "Emulators started in background (PID=$EMU_PID). Waiting for Auth emulator to be ready..."

          # wait for the auth emulator HTTP endpoint
          npx wait-on --timeout 60000 http://127.0.0.1:9095 || {
            echo "Auth emulator did not become available. Dumping emulator log:"; tail -n +1 emulators.log; kill $EMU_PID || true; exit 1
          }

          echo "Auth emulator is up; seeding vendor user..."
          curl -s -X POST 'http://127.0.0.1:9095/identitytoolkit.googleapis.com/v1/accounts:signUp?key=fake-api-key' -H 'Content-Type: application/json' -d '{"email":"vender@sender.com","password":"admin123","returnSecureToken":true}' || true

          echo "Running Playwright tests"
          # run Playwright from the workspace root so the config path resolves correctly
          pnpm -w exec -- playwright test tests/e2e --config=apps/customer-app/playwright.config.ts --reporter=list || {
            echo "Playwright failed â€” capturing emulator log"; tail -n +1 emulators.log; kill $EMU_PID || true; exit 1
          }

          # tests succeeded (or failed above); ensure the emulator process is terminated
          echo "Tests completed; stopping emulators (PID=$EMU_PID)"; kill $EMU_PID || true
          sleep 1
          tail -n +1 emulators.log | sed -n '1,200p'

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            apps/customer-app/test-results/**
            apps/customer-app/playwright-report/**
            test-results/**

  e2e-preview:
    name: E2E against built preview
    runs-on: ubuntu-latest
    needs: e2e

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build customer app
        run: pnpm --filter @gosenderr/customer-app build

      - name: Start preview server
        run: |
          # serve the built app on the same base port as Playwright expects
          pnpm --filter @gosenderr/customer-app exec -- vite preview --port 5180 --strictPort &
          npx wait-on http://localhost:5180
        env:
          CI: 'true'

      - name: Run Playwright E2E against preview
        env:
          CI: 'true'
        run: pnpm --filter @gosenderr/customer-app exec -- playwright test tests/e2e --config=apps/customer-app/playwright.config.ts --reporter=list

      - name: Upload preview test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-preview-artifacts
          path: |
            apps/customer-app/test-results/**
            apps/customer-app/playwright-report/**
            test-results/**
