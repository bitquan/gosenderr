name: Xcode Pod Triage

on:
  push:
    branches:
      - "ci/xcode-pods-triage-2"
  pull_request:
    branches:
      - main

jobs:
  pod-triage:
    name: Pod triage (macOS)
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print environment
        run: |
          xcodebuild -version
          ruby --version || true
          brew --version || true

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document
          pod --version

      - name: Install pnpm (Corepack)
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm -v

      - name: Install node deps
        run: |
          pnpm install --frozen-lockfile
        # run in repo root so pnpm workspace uses root pnpm-lock.yaml

      - name: Pod install (clean app or fallback)
        run: |
          mkdir -p /tmp/pods-target-triage
          if [ -d "apps/courieriosnativeclean/ios" ]; then
            echo "Using apps/courieriosnativeclean/ios"
            cd apps/courieriosnativeclean/ios
            pod install --verbose
          elif [ -d "apps/courier-ios-native/ios" ]; then
            echo "Fallback: using apps/courier-ios-native/ios"
            cd apps/courier-ios-native/ios
            pod install --verbose
          else
            echo "PATH_MISSING: no ios dir found for triage" > /tmp/pods-target-triage/missing-path.txt
            echo "Skipping pod install — no ios directory available"
          fi

      - name: Run pods target triage (build)
        env:
          BUILD_ACTIVE_ARCH_ONLY: "YES"
          ONLY_ACTIVE_ARCH: "YES"
        run: |
          mkdir -p /tmp/pods-target-triage
          if [ -d "apps/courieriosnativeclean/ios" ]; then
            (cd apps/courieriosnativeclean/ios && ../../scripts/test-pods-targets.sh --build --targets="gRPC-Core,rnmapbox-maps") 2>&1 | tee /tmp/pods-target-triage/run.log || true
          elif [ -d "apps/courier-ios-native/ios" ]; then
            (cd apps/courier-ios-native/ios && ../../scripts/test-pods-targets.sh --build --targets="gRPC-Core,rnmapbox-maps") 2>&1 | tee /tmp/pods-target-triage/run.log || true
          else
            echo "PATH_MISSING: no ios dir found for triage" > /tmp/pods-target-triage/missing-path.txt
            echo "Skipping build triage — no ios directory available" | tee /tmp/pods-target-triage/run.log
          fi

      - name: Archive and upload logs
        run: |
          ts=$(date +%s)
          tar -czf /tmp/pods-target-triage-$ts.tar.gz /tmp/pods-target-test-* 2>/dev/null || true
          ls -la /tmp/pods-target-test-* 2>/dev/null || true
        continue-on-error: true

      - name: Upload triage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xcode-pod-triage-logs
          path: |
            /tmp/pods-target-triage-$ts.tar.gz
            /tmp/pods-target-test-*
            /tmp/pods-target-triage/run.log

      - name: Save podfile.lock
        uses: actions/upload-artifact@v4
        with:
          name: podfile-lock
          path: apps/courieriosnativeclean/ios/Podfile.lock
