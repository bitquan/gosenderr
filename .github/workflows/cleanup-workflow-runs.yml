name: Cleanup old workflow runs

on:
  workflow_dispatch:
    inputs:
      days:
        description: 'Delete workflow runs older than this many days'
        required: true
        default: '30'
      branch:
        description: 'Optional: only consider runs from this branch (leave empty for all)'
        required: false
        default: ''
      preview:
        description: 'If true, only preview runs to delete (no deletion)'
        required: true
        default: 'true'

permissions:
  actions: write
  issues: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup or preview old workflow runs
        uses: actions/github-script@v6
        with:
          script: |
            const days = parseInt(core.getInput('days', { required: true }))
            const branch = core.getInput('branch')
            const preview = core.getInput('preview') === 'true'
            const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            core.info(`Cutoff date: ${cutoff.toISOString()}`)

            const owner = context.repo.owner
            const repo = context.repo.repo

            // Paginate through repository workflow runs
            let page = 1
            let runsToConsider = []
            while (true) {
              const res = await github.rest.actions.listWorkflowRunsForRepo({ owner, repo, per_page: 100, page })
              const runs = res.data.workflow_runs || []
              if (!runs.length) break
              for (const run of runs) {
                const createdAt = new Date(run.created_at)
                if (createdAt < cutoff) {
                  if (branch && run.head_branch !== branch) continue
                  runsToConsider.push({ id: run.id, name: run.name, event: run.event, branch: run.head_branch, created_at: run.created_at, url: run.html_url })
                }
              }
              page++
            }

            core.info(`Found ${runsToConsider.length} runs older than ${days} days${branch ? ` on branch ${branch}` : ''}`)

            if (!runsToConsider.length) {
              await github.rest.issues.create({ owner, repo, title: `Cleanup runs: none older than ${days} days`, body: `No workflow runs older than ${days} days${branch ? ` on branch ${branch}` : ''} were found.` })
              core.setOutput('deleted', '0')
              return
            }

            const listBody = runsToConsider.map(r => `- ${r.name} (branch: ${r.branch}) created: ${r.created_at}  ${r.url}  id=${r.id}`).join('\n')

            if (preview) {
              const title = `Preview: ${runsToConsider.length} workflow runs older than ${days} days${branch ? ` on ${branch}` : ''}`
              await github.rest.issues.create({ owner, repo, title, body: `This is a preview of workflow runs that would be deleted:\n\n${listBody}` })
              core.setOutput('deleted', '0')
              return
            }

            // Proceed to delete runs
            let deleted = 0
            let failed = 0
            for (const r of runsToConsider) {
              try {
                await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: r.id })
                deleted++
                core.info(`Deleted run ${r.id}`)
              } catch (err) {
                failed++
                core.warning(`Failed to delete run ${r.id}: ${err}`)
              }
            }

            const summary = `Cleanup complete: deleted ${deleted} runs, failed ${failed}.` + '\n\n' + listBody
            await github.rest.issues.create({ owner, repo, title: `Cleanup completed: deleted ${deleted} runs`, body: summary })
            core.setOutput('deleted', `${deleted}`)
