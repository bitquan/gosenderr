name: CI — Emulators & Tests

on:
  pull_request:
    branches: [ main ]

jobs:
  fork-safe-checks:
    if: ${{ github.event.pull_request && github.event.pull_request.head.repo.full_name != github.repository }}
    runs-on: ubuntu-latest
    name: Fork PR — safe checks only
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm i -g pnpm@latest

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Lint (no secrets)
        run: pnpm lint

      - name: Type check (no secrets)
        run: pnpm type-check

  emu-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache pnpm store, node_modules, and Firebase emulator binaries
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ~/.cache/pnpm
            ~/.cache/firebase/emulators
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}-node-${{ matrix.node-version }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install pnpm
        run: npm i -g pnpm@latest

      - name: Install dependencies
        run: pnpm install

      - name: Ensure customer-app has required env for emulator tests
        run: |
          mkdir -p apps/customer-app
          cat > apps/customer-app/.env <<'EOF'
VITE_FIREBASE_API_KEY=fake-api-key
VITE_FIREBASE_AUTH_DOMAIN=127.0.0.1
VITE_FIREBASE_PROJECT_ID=demo
VITE_FIREBASE_STORAGE_BUCKET=demo.appspot.com
VITE_FIREBASE_APP_ID=1:000:web:fake
NEXT_PUBLIC_MAPBOX_TOKEN=dummy_token
EOF

      - name: Install Firebase CLI
        run: pnpm dlx firebase-tools --version

      - name: Validate FIREBASE_TOKEN (if provided)
        if: ${{ secrets.FIREBASE_TOKEN }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Validating FIREBASE_TOKEN..."
          # projects:list is a lightweight call to validate token authentication
          firebase projects:list --token "$FIREBASE_TOKEN" --format=json >/dev/null || (echo "FIREBASE_TOKEN is invalid or lacks permissions" && exit 1)

      - name: Run Functions integration tests under emulators
        env:
          GCLOUD_PROJECT: demo
        run: |
          # ensure function package deps are installed and result dir exists
          npx firebase emulators:exec --only firestore,auth "cd firebase/functions && pnpm install && mkdir -p ../functions-test-results && pnpm run test:integration -- --reporter mocha-junit-reporter --reporter-options mochaFile=../functions-test-results/results.xml"

      - name: Run Admin App tests under emulators (Vitest)
        env:
          GCLOUD_PROJECT: demo
        run: |
          npx firebase emulators:exec --only firestore,auth "cd apps/admin-app && pnpm install && pnpm run test -- --run --reporter junit --reporter-options outputFile=vitest-junit.xml"

      - name: Collect test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            functions-test-results/**
            apps/admin-app/vitest-junit.xml

      - name: Warn about missing FIREBASE_TOKEN
        if: "${{ !secrets.FIREBASE_TOKEN }}"
        run: |
          echo "Warning: FIREBASE_TOKEN is not configured; some emulator features may show warnings in CI. Consider adding as a repository secret."

      - name: Show workspace (for debugging)
        if: "${{ github.event.action == 'opened' || github.event.action == 'synchronize' }}"
        run: ls -la
