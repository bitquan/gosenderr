# GoSenderr Platform - Copilot Instructions

TL;DR
- Location: .github/copilot-instructions.md
- Purpose: Master context for GitHub Copilot to make safe, reviewable changes.
- Governance: Copilot may create branches and PRs but **human approval is required** for merges to protected branches and destructive changes.

---

## Project Overview
GoSenderr is a delivery platform with 3 production apps:
1. **Customer/Marketplace App** (apps/customer-app) - Port 5173
2. **Courier App** (apps/courier-app) - Port 5174 - MAP IS THE SHELL
3. **Admin Panel** (apps/admin-app) - Port 5176 - Web only

## Tech Stack
- **Frontend:** Vite + React 19 + TypeScript + Tailwind CSS
- **Mobile:** Capacitor (iOS/Android from web apps)
- **Backend:** Firebase (Auth, Firestore, Cloud Functions, Storage)
- **Maps:** Mapbox GL JS
- **Payments:** Stripe + Stripe Connect
- **Routing:** React Router v7

## Architecture Principles
- **Courier App:** Map-first UI - Full-screen Mapbox with floating components
- **Marketplace:** Customer + Vendor unified app
- **Admin:** Web-only dashboard (macOS app later)
- **No Shifter/Runner app** (archived for future)

## Code Style
- TypeScript strict mode
- Functional components only (no class components)
- Hooks over context where possible
- Tailwind for all styling (no CSS modules)
- Firebase v10+ modular SDK only

## File Naming Conventions
- Components: `PascalCase.tsx`
- Hooks: `useCamelCase.ts`
- Utils: `camelCase.ts`
- Pages: `page.tsx` (React Router convention)

## Import Order
1. React/React Router
2. External libraries (firebase, mapbox, stripe)
3. Internal components (@/components)
4. Internal hooks (@/hooks)
5. Internal utils (@/lib)
6. Types (@gosenderr/shared)
7. Styles (if any)

## Firebase Rules
- All security rules in `firebase/firestore.rules` (740 lines - complete)
- Storage rules in `firebase/storage.rules` (complete)
- Cloud Functions in `firebase/functions/src/`

## Testing
- E2E: Playwright
- Unit: Vitest (when needed)
- Firebase Emulators for local dev

## Deployment
- Customer app: `gosenderr-customer.web.app`
- Courier app: `gosenderr-courier.web.app`
- Admin app: `gosenderr-admin.web.app`

## Current Focus
Phase-by-phase refactor to production-ready state.
See `docs/IMPLEMENTATION_PLAN.md` for detailed roadmap.

## Critical Context
- **Courier schema:** Use `courierProfile` only, never legacy `courier` field
- **Map Shell:** Courier app dashboard = full-screen map + bottom sheet
- **Payout flow:** Customer pays → Platform captures → Transfer to courier Stripe Connect
- **Mobile-first:** All web apps must work on iOS/Android via Capacitor

## Governance & Safety (NEW)
- Allowed Copilot actions:
  - Create files and branches named `copilot/*` or `chore/copilot/*`
  - Open PRs with the label `generated-by-copilot`
  - Run tests locally or via existing CI scripts
- Human approval REQUIRED for:
  - Merges to `main`, `production`, or any protected branch
  - Destructive operations (deleting data, cleaning workflow runs, removing infra)
  - Changes to deployment/CI configuration that affect production
- PRs generated by Copilot must include:
  - A clear description of changes
  - Tests or verifications added/updated
  - A short QA checklist for reviewers

## Secrets & Sensitive Data (NEW)
- Never commit secrets, keys, or credentials to the repository.
- Use GitHub Secrets or environment variables for production values.
- Copilot should not suggest or add secrets to code or `.env` files.

## When Writing Code (updated)
- Always use TypeScript (avoid `any` types)
- Handle loading states and error states
- Use debug logging during development; remove, guard, or use proper logging libraries before merging
- Always use Firebase server timestamps for created/updated fields
- Validate user input and sanitize external data
- Check authentication before Firestore reads

## PR & Review Guidelines (NEW)
- Branches: Copilot-created branches must follow `copilot/<task>` or `chore/copilot/<task>` naming
- Labels: Add `generated-by-copilot` and appropriate area labels (e.g., `area: courier`) to PRs
- Reviewers: Assign at least one human reviewer for any PR touching production code
- CI: All checks must pass before merging
- Manual QA: If a change affects UX or flows, add a short manual QA checklist in the PR

## File Structure Patterns
``` 
apps/[app-name]/
├── src/
│   ├── components/     # Reusable UI components
│   ├── pages/          # Route pages (page.tsx)
│   ├── layouts/        # Layout wrappers
│   ├── hooks/          # Custom React hooks
│   ├── lib/            # Utilities
│   │   ├── firebase/   # Firebase config & helpers
│   │   └── utils.ts    # General utilities
│   ├── contexts/       # React contexts (minimize use)
│   └── types/          # TypeScript types (prefer shared package)
├── public/             # Static assets
└── capacitor.config.ts # Mobile config (customer & courier only)
```

## Common Patterns

### Firebase Queries
```typescript
import { collection, query, where, orderBy, onSnapshot } from 'firebase/firestore';
import { db } from '@/lib/firebase';

// Prefer real-time listeners when appropriate
const unsubscribe = onSnapshot(
  query(
    collection(db, 'jobs'),
    where('status', '==', 'open'),
    orderBy('createdAt', 'desc')
  ),
  (snapshot) => {
    const jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    setJobs(jobs);
  }
);

return () => unsubscribe();
```

### Authentication Guards
```typescript
import { useAuth } from '@/hooks/useAuth';
import { Navigate } from 'react-router-dom';

function ProtectedRoute({ children }) {
  const { user, loading } = useAuth();
  
  if (loading) return <LoadingSpinner />;
  if (!user) return <Navigate to="/login" />;
  
  return children;
}
```

### Mapbox Integration (Courier App)
```typescript
import mapboxgl from 'mapbox-gl';
import { useEffect, useRef } from 'react';

function MapShell() {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);

  useEffect(() => {
    if (map.current) return; // Initialize once
    
    map.current = new mapboxgl.Map({
      container: mapContainer.current!,
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-122.4, 37.8],
      zoom: 12,
    });
  }, []);

  return <div ref={mapContainer} className="w-full h-full" />;
}
```

### Stripe Payments
```typescript
import { loadStripe } from '@stripe/stripe-js';
import { Elements } from '@stripe/react-stripe-js';

const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLIC_KEY);

<Elements stripe={stripePromise}>
  <CheckoutForm />
</Elements>
```

## Cloud Functions Patterns
```typescript
import * as functions from 'firebase-functions/v2';
import * as admin from 'firebase-admin';

export const transferPayout = functions.firestore
  .document('deliveryJobs/{jobId}')
  .onUpdate(async (change, context) => {
    const before = change.before.data();
    const after = change.after.data();
    
    // Check conditions
    if (after.customerConfirmation?.received && after.paymentStatus === 'captured') {
      // Transfer to courier
    }
  });
```

## Environment Variables
All apps use `.env.local` with `VITE_` prefix:
- VITE_FIREBASE_API_KEY
- VITE_FIREBASE_PROJECT_ID
- VITE_MAPBOX_TOKEN
- VITE_STRIPE_PUBLIC_KEY

Cloud Functions use Firebase Secrets:
- STRIPE_SECRET_KEY (secret)
- STRIPE_WEBHOOK_SECRET (secret)

## Mobile Considerations
- Use `safe-area-inset-*` for iOS notch
- Handle Android back button
- Request permissions before using Geolocation/Camera
- Test on real devices, not just simulators

## Performance
- Lazy load routes with React.lazy()
- Memoize expensive calculations with useMemo
- Debounce search inputs
- Use Firestore indexes for complex queries
- Compress images before upload

## Security
- Validate all user input
- Sanitize HTML (use DOMPurify if needed)
- Check auth on every Cloud Function
- Use Firestore security rules (already complete)
- Never expose API keys in client code

## Debugging
- Use `console.log`/debuggers during development
- Use React DevTools
- Use Firebase Emulator UI for Firestore inspection
- Use Mapbox debugging tools
- Check Network tab for failed requests

---

**When in doubt:**
1. Check existing code patterns in the app
2. Prefer TypeScript strict typing
3. Handle errors gracefully
4. Add loading states
5. Test on mobile if UI-related

---

## PR Checklist (example to include in PRs)
- [ ] Changes compile and pass tests
- [ ] New code includes unit/E2E tests where applicable
- [ ] No secrets committed
- [ ] Manual QA steps included if UX changes
- [ ] At least one human reviewer assigned

---

*Generated guidance maintained by the GoSenderr team. For questions or modifications to Copilot policy, contact the repository owners.*
