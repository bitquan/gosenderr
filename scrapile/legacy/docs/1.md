# ğŸ“‹ **COPILOT TASK: FIX WEB APP CRITICAL ISSUES**

---

## ğŸ¯ **TASK OVERVIEW**

Clean up the GoSenderR web application to ensure stable, production-ready functionality before mobile development. This task focuses on removing legacy code, consolidating schemas, and testing complete user flows.

**Duration:** 2-3 days  
**Priority:** Critical  
**Type:** Refactoring + Bug Fixes + Testing

---

## ğŸ¯ **OBJECTIVES**

1. **Remove all legacy courier schema references**
2. **Consolidate to courierProfile schema only**
3. **Test complete Order Up â†’ Senderr â†’ Market Senderr flows**
4. **Fix any payment/delivery issues**
5. **Ensure real-time updates work correctly**

---

## ğŸ“‹ **DETAILED TASKS**

### **TASK 1: Remove Legacy Courier Schema Fallbacks**

#### **Priority:** Critical  
#### **Time:** 2-3 hours

**Problem:**
The codebase has dual schema support (legacy `courier` field vs new `courierProfile` field). This causes confusion and potential bugs.

**Files to Update:**

#### **1.1 Checkout Page - Remove Fallbacks**

**File:** `apps/web/src/app/customer/checkout/page.tsx`

**Current code (around line 126-131):**
```typescript
const rateCard = isFood
  ? courierData.courierProfile?.foodRateCard ||
    courierData.courier?.rateCard        // âŒ REMOVE THIS FALLBACK
  : courierData.courierProfile?.packageRateCard ||
    courierData.courier?.rateCard;       // âŒ REMOVE THIS FALLBACK
```

**Change to:**
```typescript
const rateCard = isFood
  ? courierData.courierProfile?.foodRateCard
  : courierData.courierProfile?.packageRateCard;

// Skip Senderr if they don't have the appropriate rate card
if (!rateCard) {
  console.log(`Senderr ${courierId} missing ${isFood ? 'food' : 'package'} rate card, skipping`);
  continue; // Skip this Senderr in the loop
}
```

#### **1.2 Request Delivery Page - Remove Fallbacks**

**File:** `apps/web/src/app/customer/request-delivery/page.tsx`

Find similar patterns where `courier?.rateCard` is used as a fallback and remove them.

**Search for:**
- `courier?.rateCard`
- `courier.rateCard`
- `courierData.courier?.`

**Replace with:**
- Only use `courierProfile.packageRateCard` or `courierProfile.foodRateCard`
- Add null checks and skip Senderrs without proper rate cards

#### **1.3 Global Search & Replace**

**Search entire codebase for:**
```bash
# In apps/web directory
grep -r "courier?.rateCard" apps/web/src/
grep -r "courier.rateCard" apps/web/src/
grep -r "courier.isOnline" apps/web/src/
grep -r "courier.transportMode" apps/web/src/
```

**For each occurrence:**
- If in customer-facing code: Replace with `courierProfile` equivalent
- If in courier-facing code: Verify it's using `courierProfile`
- If no `courierProfile` equivalent exists: Remove or skip that Senderr

---

### **TASK 2: Update Senderr Discovery Logic**

#### **Priority:** High  
#### **Time:** 1-2 hours

**Problem:**
Senderr discovery needs to check `courierProfile` fields consistently.

**File:** `apps/web/src/app/customer/checkout/page.tsx` (and similar discovery code)

**Current Senderr filtering (approximate location):**
```typescript
// Around line 80-120 in CheckoutClient.tsx
const couriersSnapshot = await getDocs(
  query(
    collection(db, "users"),
    where("role", "==", "courier")
  )
);
```

**Update to check courierProfile:**
```typescript
const couriersSnapshot = await getDocs(
  query(
    collection(db, "users"),
    where("role", "==", "courier")
  )
);

const availableCouriers = couriersSnapshot.docs
  .map(doc => ({ id: doc.id, ...doc.data() }))
  .filter(courier => {
    // Must have courierProfile
    if (!courier.courierProfile) {
      console.log(`Senderr ${courier.id} has no courierProfile, skipping`);
      return false;
    }

    // Must be approved
    if (courier.courierProfile.status !== 'approved') {
      console.log(`Senderr ${courier.id} not approved (status: ${courier.courierProfile.status}), skipping`);
      return false;
    }

    // Must be online
    if (!courier.courierProfile.isOnline) {
      console.log(`Senderr ${courier.id} is offline, skipping`);
      return false;
    }

    // Must have current location
    if (!courier.courierProfile.currentLocation) {
      console.log(`Senderr ${courier.id} has no location, skipping`);
      return false;
    }

    // Must have appropriate rate card for job type
    const hasRateCard = isFood 
      ? !!courier.courierProfile.foodRateCard
      : !!courier.courierProfile.packageRateCard;
    
    if (!hasRateCard) {
      console.log(`Senderr ${courier.id} missing ${isFood ? 'food' : 'package'} rate card, skipping`);
      return false;
    }

    // Must have work mode enabled
    const workModeEnabled = isFood
      ? courier.courierProfile.workModes?.foodEnabled
      : courier.courierProfile.workModes?.packagesEnabled;
    
    if (!workModeEnabled) {
      console.log(`Senderr ${courier.id} has ${isFood ? 'food' : 'package'} mode disabled, skipping`);
      return false;
    }

    return true;
  });
```

---

### **TASK 3: Verify Senderr Dashboard Uses courierProfile**

#### **Priority:** High  
#### **Time:** 30 minutes

**File:** `apps/web/src/app/courier/dashboard/page.tsx`

**Verify these checks exist:**

```typescript
// Should already be done based on recent commits, but verify:

// 1. Check for courierProfile existence
const hasRateCard =
  userDoc?.courierProfile?.packageRateCard ||
  userDoc?.courierProfile?.foodRateCard;

if (!hasRateCard) {
  router.push("/courier/rate-cards");
  return;
}

// 2. Check online status from courierProfile
const isOnline = userDoc?.courierProfile?.isOnline;

// 3. Use courierProfile.currentLocation
const courierLocation = userDoc?.courierProfile?.currentLocation;

// 4. NO references to userDoc.courier (legacy)
// Search for and remove any userDoc.courier references
```

**Action:**
- Search `courier/dashboard/page.tsx` for `userDoc.courier`
- Replace all with `userDoc.courierProfile` equivalents
- Verify online toggle updates `courierProfile.isOnline`

---

### **TASK 4: Test Complete User Flows**

#### **Priority:** Critical  
#### **Time:** 3-4 hours

Test these flows end-to-end and document any issues:

#### **Flow 1: Senderr Onboarding & Setup**

**Steps:**
1. Create new account â†’ Select "Senderr" role
2. Should redirect to `/courier/onboarding`
3. Complete all 5 steps:
   - Step 1: Select vehicle (car), service radius (15 miles)
   - Step 2: Enable packages â˜‘ï¸ and food â˜‘ï¸
   - Step 3: Set package rate card (base $3, per mile $0.50, per minute $0.10)
   - Step 4: Set food rate card (base $2.50, per mile $0.75, wait pay $0.15)
   - Step 5: Review & Submit
4. Verify redirect to `/courier/dashboard`
5. Verify status shows `pending_review`

**Expected Results:**
- âœ… User document has `role: 'courier'`
- âœ… `courierProfile` object created with all fields
- âœ… `courierProfile.status === 'pending_review'`
- âœ… Both rate cards saved correctly
- âœ… Work modes set: `packagesEnabled: true, foodEnabled: true`
- âœ… NO `courier` legacy field created

**Database Check:**
```javascript
// In Firebase Console or via script
const userDoc = await db.collection('users').doc(userId).get();
const data = userDoc.data();

console.log('Role:', data.role); // Should be 'courier'
console.log('Has courierProfile:', !!data.courierProfile); // Should be true
console.log('Has legacy courier:', !!data.courier); // Should be false or undefined
console.log('Package rate card:', data.courierProfile.packageRateCard);
console.log('Food rate card:', data.courierProfile.foodRateCard);
console.log('Status:', data.courierProfile.status); // Should be 'pending_review'
```

---

#### **Flow 2: Admin Approves Senderr**

**Steps:**
1. Log in as admin
2. Go to `/admin/users` (or use Firebase Console)
3. Find the Senderr user
4. Update `courierProfile.status` to `'approved'`

**Manual Update (Firebase Console):**
```
users/{senderId}/courierProfile/status = "approved"
```

**OR via script:**
```javascript
await db.collection('users').doc(senderId).update({
  'courierProfile.status': 'approved'
});
```

---

#### **Flow 3: Senderr Goes Online**

**Steps:**
1. Log in as approved Senderr
2. Go to `/courier/dashboard`
3. Click "Go Online" button (or toggle)
4. Allow location permissions
5. Verify location tracking starts

**Expected Results:**
- âœ… `courierProfile.isOnline` updates to `true`
- âœ… `courierProfile.currentLocation` updates with GPS coordinates
- âœ… Location updates every 10-30 seconds
- âœ… Dashboard shows "Online" status
- âœ… Available sends appear on map/list

**Database Check:**
```javascript
const userDoc = await db.collection('users').doc(senderId).get();
const profile = userDoc.data().courierProfile;

console.log('Online:', profile.isOnline); // Should be true
console.log('Location:', profile.currentLocation); // Should have {lat, lng, timestamp}
console.log('Last updated:', profile.currentLocation?.timestamp?.toDate());
```

---

#### **Flow 4: Order Up Requests Delivery**

**Steps:**
1. Log in as Order Up (customer)
2. Browse marketplace â†’ select item
3. Click "Request Delivery"
4. Enter dropoff address
5. Select Senderr from list
6. Complete checkout

**Expected Results:**
- âœ… Approved, online Senderrs appear in list
- âœ… Senderrs with correct rate card for item type (food/package) shown
- âœ… Senderrs with disabled work modes are hidden
- âœ… Pricing calculated correctly using `courierProfile` rate card
- âœ… NO errors about missing rate cards
- âœ… Order created successfully

**Debug Logging:**
Add temporary console logs in checkout to verify:
```typescript
console.log('Available Senderrs:', availableCouriers.map(c => ({
  id: c.id,
  isOnline: c.courierProfile?.isOnline,
  status: c.courierProfile?.status,
  hasPackageCard: !!c.courierProfile?.packageRateCard,
  hasFoodCard: !!c.courierProfile?.foodRateCard,
  packageMode: c.courierProfile?.workModes?.packagesEnabled,
  foodMode: c.courierProfile?.workModes?.foodEnabled
})));
```

---

#### **Flow 5: Senderr Accepts & Completes Send**

**Steps:**
1. Log in as Senderr
2. Dashboard shows available sends
3. Click on send
4. Review details
5. Click "Accept Send"
6. Status updates to `enroute_pickup`
7. Navigate to pickup
8. Click "Picked Up"
9. Status updates to `picked_up`
10. Navigate to dropoff
11. Take delivery photo
12. Click "Complete"
13. Status updates to `delivered`

**Expected Results:**
- âœ… Job status updates in real-time
- âœ… Order Up sees status updates
- âœ… Payment processes correctly
- âœ… Senderr earnings recorded
- âœ… Platform fee recorded
- âœ… Market Senderr (if applicable) gets paid

---

#### **Flow 6: Market Senderr Lists & Sells Item**

**Steps:**
1. Log in as Market Senderr (vendor)
2. Go to `/marketplace/create`
3. List new item with:
   - Title: "Test Item"
   - Price: $15
   - Category: Electronics
   - Pickup location: (set address)
   - Photos: Upload 1-2
4. Submit listing
5. Item appears in marketplace
6. Order Up purchases item (Flow 4)
7. Senderr delivers (Flow 5)
8. Market Senderr receives payout

**Expected Results:**
- âœ… Only users with `role: 'vendor'` can create items
- âœ… Stripe Connect account required for payouts
- âœ… Item appears in marketplace immediately
- âœ… Order created correctly
- âœ… Market Senderr sees order in `/vendor/orders`
- âœ… After delivery, payout processed via Stripe

---

### **TASK 5: Fix Any Issues Found in Testing**

#### **Priority:** Critical  
#### **Time:** Variable (2-6 hours depending on issues)

**Document each issue:**
```markdown
## Issue 1: [Title]
**Severity:** Critical/High/Medium/Low
**Found in:** Flow X, Step Y
**Description:** What went wrong
**Expected:** What should happen
**Actual:** What actually happened
**Error messages:** (if any)
**Fix:** Proposed solution
```

**Common issues to watch for:**
- Senderr not appearing in discovery
- Rate card calculation errors
- Payment processing failures
- Status not updating in real-time
- Location not tracking
- Photos not uploading

---

### **TASK 6: Database Cleanup (Optional)**

#### **Priority:** Low  
#### **Time:** 1 hour

**Only if safe to do:**

Create a script to migrate any existing users with legacy `courier` field:

```javascript
// scripts/migrate-courier-schema.js

const admin = require('firebase-admin');
const serviceAccount = require('./serviceAccountKey.json');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const db = admin.firestore();

async function migrateCourierData() {
  const usersSnapshot = await db.collection('users')
    .where('role', '==', 'courier')
    .get();

  const batch = db.batch();
  let count = 0;

  for (const doc of usersSnapshot.docs) {
    const data = doc.data();
    
    // If has legacy courier field but no courierProfile
    if (data.courier && !data.courierProfile) {
      console.log(`Migrating user ${doc.id}...`);
      
      // Convert legacy courier to courierProfile
      const courierProfile = {
        vehicleType: data.courier.transportMode || 'car',
        status: 'approved', // Assume legacy couriers were approved
        isOnline: data.courier.isOnline || false,
        currentLocation: data.location || null,
        
        // Convert legacy rate card to package rate card
        packageRateCard: {
          baseFare: data.courier.rateCard?.baseFee || 3,
          perMile: data.courier.rateCard?.perMile || 0.50,
          perMinute: data.courier.rateCard?.perMinute || 0.10,
          optionalFees: []
        },
        
        workModes: {
          packagesEnabled: true,
          foodEnabled: false
        },
        
        serviceRadius: data.courier.rateCard?.maxRadiusMiles || 15,
        createdAt: data.createdAt || admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
      };
      
      batch.update(doc.ref, {
        courierProfile,
        // Keep courier field for now (don't delete until verified)
        updatedAt: admin.firestore.Timestamp.now()
      });
      
      count++;
      
      // Commit batch every 500 operations
      if (count % 500 === 0) {
        await batch.commit();
        console.log(`Migrated ${count} users so far...`);
      }
    }
  }
  
  if (count > 0) {
    await batch.commit();
    console.log(`âœ… Migration complete! Migrated ${count} users.`);
  } else {
    console.log('No users to migrate.');
  }
}

migrateCourierData()
  .then(() => process.exit(0))
  .catch(err => {
    console.error('Migration failed:', err);
    process.exit(1);
  });
```

**Don't run this until:**
- âœ… All flows tested and working
- âœ… Backup database created
- âœ… Verified on staging environment

---

## âœ… **ACCEPTANCE CRITERIA**

### **Code Quality:**
- [ ] No references to `courier?.rateCard` in customer-facing code
- [ ] No references to `courier.isOnline` (use `courierProfile.isOnline`)
- [ ] No references to `courier.transportMode` (use `courierProfile.vehicleType`)
- [ ] All Senderr discovery uses `courierProfile` fields
- [ ] Console has no errors during normal flows

### **Functionality:**
- [ ] Senderr onboarding creates `courierProfile` (NOT `courier`)
- [ ] Approved Senderrs appear in Order Up checkout
- [ ] Unapproved Senderrs do NOT appear
- [ ] Offline Senderrs do NOT appear
- [ ] Senderrs without rate cards do NOT appear
- [ ] Payment processing works end-to-end
- [ ] Real-time status updates work

### **Testing:**
- [ ] Flow 1 (Senderr onboarding) passes
- [ ] Flow 2 (Admin approval) passes
- [ ] Flow 3 (Senderr goes online) passes
- [ ] Flow 4 (Order Up requests delivery) passes
- [ ] Flow 5 (Senderr accepts & completes) passes
- [ ] Flow 6 (Market Senderr sells) passes
- [ ] No console errors
- [ ] No broken links
- [ ] All role names show correctly (Order Up, Market Senderr, Senderr, Shifter)

---

## ğŸ“¦ **DELIVERABLES**

1. **Updated Files:**
   - `apps/web/src/app/customer/checkout/page.tsx`
   - `apps/web/src/app/customer/request-delivery/page.tsx`
   - `apps/web/src/app/courier/dashboard/page.tsx`
   - Any other files with legacy courier references

2. **Test Report:**
   - Document results of all 6 flows
   - Screenshot evidence of working flows
   - List of any bugs found and fixed

3. **Database Verification:**
   - Confirm new Senderrs create `courierProfile` only
   - Confirm no new `courier` fields being created
   - Document any legacy data that needs migration

---

## ğŸš¨ **CRITICAL WARNINGS**

### **DO NOT:**
- âŒ Delete existing `courier` fields from production database (yet)
- âŒ Break existing Senderrs who might still use legacy schema
- âŒ Deploy without testing all flows
- âŒ Change Firestore security rules without verification

### **DO:**
- âœ… Test thoroughly on staging/development first
- âœ… Keep console logging for debugging
- âœ… Document all changes
- âœ… Create database backup before any migration
- âœ… Ask for clarification if anything is unclear

---

## ğŸ”„ **AFTER COMPLETION**

Once all flows pass and code is clean:

1. Deploy to staging
2. Test again on staging
3. Get user approval
4. Deploy to production
5. Monitor for errors
6. **THEN** we can start mobile development with confidence! ğŸš€

---

## ğŸ“ **QUESTIONS BEFORE STARTING?**

- Is the current terminology update fully working?
- Are there any known bugs I should be aware of?
- Do you have a staging environment set up?
- Should I create the migration script or skip it for now?

---

**Ready to execute this task?** Let me know if you need any clarification or want me to adjust anything! ğŸ¯