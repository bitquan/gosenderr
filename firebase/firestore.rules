rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========
    
    function signedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }
    
    function isAdmin() {
      return signedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function validRole(role) {
      return role in ['buyer', 'seller', 'courier', 'admin', 'customer', 'runner', 'vendor', 'package_runner'];
    }
    
    function validNonAdminRole(role) {
      return role in ['buyer', 'seller', 'courier', 'customer', 'runner', 'vendor', 'package_runner'];
    }

    function validJobStatus(s) {
      return s in ['open', 'assigned', 'enroute_pickup', 'arrived_pickup', 'picked_up', 
                   'enroute_dropoff', 'arrived_dropoff', 'completed', 'cancelled', 'disputed'];
    }

    function validPackageSize(size) {
      return size in ['small', 'medium', 'large', 'xl'];
    }

    function validPackageFlags(flags) {
      return flags == null || (
        flags is map
        && (!('needsSuvVan' in flags) || flags.needsSuvVan is bool)
        && (!('fragile' in flags) || flags.fragile is bool)
        && (!('heavyTwoPerson' in flags) || flags.heavyTwoPerson is bool)
        && (!('oversized' in flags) || flags.oversized is bool)
        && (!('stairs' in flags) || flags.stairs is bool)
      );
    }

    function validPackageInfo(pkg) {
      return pkg is map
        && validPackageSize(pkg.size)
        && validPackageFlags(pkg.get('flags', null))
        && (!('notes' in pkg) || (pkg.notes is string && pkg.notes.size() <= 300));
    }
    
    function validItemCategory(cat) {
      return cat in ['electronics', 'furniture', 'clothing', 'food', 'other'];
    }
    
    function validItemCondition(cond) {
      return cond in ['new', 'like_new', 'good', 'fair', 'poor'];
    }
    
    function validItemStatus(status) {
      return status in ['available', 'pending', 'sold'];
    }

    // ========== USERS ==========
    match /users/{uid} {
      // Anyone can read user documents (for marketplace, tracking, etc)
      allow read: if true;
      
      // Users can create their own document (but NOT with admin role)
      allow create: if isSelf(uid) && validNonAdminRole(request.resource.data.role);
      
      // Users can update their own document (but cannot change role to admin)
      allow update: if isSelf(uid) && (!('role' in request.resource.data) || validNonAdminRole(request.resource.data.role));
      
      // Admins can do everything
      allow read, write: if isAdmin();
      
      allow delete: if false;
    }

    // ========== ITEMS (Marketplace) ==========
    match /items/{itemId} {
      // Anyone can read available items (public marketplace)
      allow read: if true;
      
      // Any user can create items (they become the seller)
      allow create: if signedIn()
        && request.resource.data.sellerId == request.auth.uid
        && validItemCategory(request.resource.data.category)
        && validItemCondition(request.resource.data.condition)
        && validItemStatus(request.resource.data.status)
        && request.resource.data.photos is list
        && request.resource.data.photos.size() <= 10;
      
      // Only seller can update/delete their items
      allow update, delete: if signedIn() && resource.data.sellerId == request.auth.uid;
      
      // Admins can read/update/delete any item
      allow read, update, delete: if isAdmin();
    }

    // ========== DELIVERY JOBS ==========
    match /deliveryJobs/{jobId} {
      function isCustomer() {
        return signedIn() && resource.data.customerId == request.auth.uid;
      }
      
      function isSeller() {
        return signedIn() && resource.data.sellerId == request.auth.uid;
      }

      function isCourier() {
        return signedIn() && resource.data.get('courierId', null) == request.auth.uid;
      }
      
      function isParticipant() {
        return isCustomer() || isSeller() || isCourier();
      }
      
      // Read: customer, seller, courier, or admin
      allow read: if signedIn() && (isParticipant() || isAdmin());
      
      // Create: customer or seller can create delivery jobs
      allow create: if signedIn()
        && (request.resource.data.customerId == request.auth.uid || request.resource.data.sellerId == request.auth.uid)
        && request.resource.data.status == 'open'
        && request.resource.data.get('courierId', null) == null
        && validJobStatus(request.resource.data.status)
        && request.resource.data.jobType in ['package', 'food'];
      
      // Update: various scenarios
      allow update: if signedIn() && (
        // 1) Customer/Seller can cancel if status is 'open' or 'assigned'
        (
          (isCustomer() || isSeller())
          && request.resource.data.status == 'cancelled'
          && resource.data.status in ['open', 'assigned']
        )
        ||
        // 2) Any courier can claim an open job
        (
          resource.data.status == 'open'
          && resource.data.get('courierId', null) == null
          && request.resource.data.courierId == request.auth.uid
          && request.resource.data.status == 'assigned'
        )
        ||
        // 3) Assigned courier can update job progress
        (
          isCourier()
          && validJobStatus(request.resource.data.status)
        )
        ||
        // 4) Customer can confirm delivery or dispute
        (
          isCustomer()
          && resource.data.status == 'completed'
          && (
            // Confirm receipt
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['customerConfirmation', 'updatedAt'])
            ||
            // Open dispute
            request.resource.data.status == 'disputed'
          )
        )
        ||
        // 5) Admin can update any job
        isAdmin()
      );
      
      allow delete: if false;
    }

    // ========== LEGACY JOBS (backward compatibility) ==========
    match /jobs/{jobId} {
      function isCreator() {
        return signedIn() && resource.data.createdByUid == request.auth.uid;
      }

      function isAssignedCourier() {
        return signedIn() && resource.data.courierUid == request.auth.uid;
      }

      // create job: must be signed in and set createdByUid to yourself
      allow create: if signedIn()
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.status == 'open'
        && request.resource.data.courierUid == null
        && validPackageInfo(request.resource.data.package)
        && request.resource.data.photos is list;

      // read job: creator, assigned courier, or any signed-in user for open jobs
      allow read: if signedIn() && (
        isCreator()
        || isAssignedCourier()
        || resource.data.status == 'open'
      );

      // update job
      allow update: if signedIn() && (
        // 1) Creator can cancel their own job if status is 'open' or 'assigned'
        (
          isCreator() 
          && request.resource.data.status == 'cancelled'
          && (resource.data.status == 'open' || resource.data.status == 'assigned')
        )
        ||
        // 2) Any courier can claim an open job (atomic claim)
        (
          resource.data.status == 'open'
          && resource.data.courierUid == null
          && request.resource.data.courierUid == request.auth.uid
          && request.resource.data.status == 'assigned'
          && request.resource.data.agreedFee is number
        )
        ||
        // 3) Assigned courier can update job progress
        (
          isAssignedCourier()
          && request.resource.data.courierUid == resource.data.courierUid
          && request.resource.data.createdByUid == resource.data.createdByUid
          && request.resource.data.agreedFee == resource.data.agreedFee
          && request.resource.data.pickup == resource.data.pickup
          && request.resource.data.dropoff == resource.data.dropoff
          && validJobStatus(request.resource.data.status)
        )
      );
      
      // Admins have full access
      allow read, write: if isAdmin();

      allow delete: if false;
    }
    
    // ========== RATINGS ==========
    match /ratings/{ratingId} {
      // Anyone can read ratings
      allow read: if signedIn();
      
      // Only the fromUserId can create their rating
      allow create: if signedIn()
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.stars >= 1
        && request.resource.data.stars <= 5
        && request.resource.data.role in ['customer_to_courier', 'courier_to_customer'];
      
      // Cannot update or delete ratings
      allow update, delete: if false;
      
      // Admins can read all ratings
      allow read: if isAdmin();
    }
    
    // ========== DISPUTES ==========
    match /disputes/{disputeId} {
      function isReporter() {
        return signedIn() && resource.data.reportedBy == request.auth.uid;
      }
      
      function isReportedAgainst() {
        return signedIn() && resource.data.reportedAgainst == request.auth.uid;
      }
      
      // Read: reporter, reported user, or admin
      allow read: if signedIn() && (isReporter() || isReportedAgainst() || isAdmin());
      
      // Create: any user can create a dispute for a delivery they're involved in
      allow create: if signedIn()
        && request.resource.data.reportedBy == request.auth.uid
        && request.resource.data.status == 'open';
      
      // Update: only admins can update disputes
      allow update: if isAdmin();
      
      allow delete: if false;
    }

    // ========== ROUTES (Local Delivery Routes) ==========
    match /routes/{routeId} {
      function isCourier() {
        return signedIn() && resource.data.get('courierId', null) == request.auth.uid;
      }
      
      // Any authenticated courier can view available routes
      allow read: if signedIn();
      
      // Couriers can claim routes (update status to 'claimed')
      allow update: if signedIn()
        && (request.resource.data.status == 'claimed' || isCourier());
      
      // Admins have full access
      allow read, write: if isAdmin();
      
      // Only system/cloud functions should create routes
      allow create, delete: if false;
    }

    // ========== LONG ROUTES (Regional Routes 50-200mi) ==========
    match /longRoutes/{routeId} {
      function isRunner() {
        return signedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'runner';
      }
      
      function isAssignedRunner() {
        return signedIn() && resource.data.get('runnerId', null) == request.auth.uid;
      }
      
      // Runners can view all long routes
      allow read: if isRunner();
      
      // Runners can accept routes and update their assigned routes
      allow update: if isRunner() && (request.resource.data.status == 'accepted' || isAssignedRunner());
      
      // Admins have full access
      allow read, write: if isAdmin();
      
      // Only system/cloud functions should create routes
      allow create, delete: if false;
    }

    // ========== LONG HAUL ROUTES (Interstate Routes 200+mi) ==========
    match /longHaulRoutes/{routeId} {
      function isRunner() {
        return signedIn() && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'runner' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'package_runner'
        );
      }
      
      function isAssignedRunner() {
        return signedIn() && resource.data.get('runnerId', null) == request.auth.uid;
      }
      
      // Runners can view all long haul routes
      allow read: if isRunner();
      
      // Runners can accept routes and update their assigned routes
      allow update: if isRunner() && (request.resource.data.status == 'accepted' || isAssignedRunner());
      
      // Admins have full access
      allow read, write: if isAdmin();
      
      // Only system/cloud functions should create routes
      allow create, delete: if false;
    }

    // ========== HUBS (Distribution Centers) ==========
    match /hubs/{hubId} {
      // Anyone can read hub information (needed for package shipping UI)
      allow read: if true;
      
      // Only admins can manage hubs
      allow create, update, delete: if isAdmin();
    }

    // ========== PACKAGES (Package Shipping) ==========
    match /packages/{packageId} {
      function isPackageSender() {
        return signedIn() && resource.data.senderId == request.auth.uid;
      }
      
      function isRunner() {
        return signedIn() && resource.data.get('runnerId', null) == request.auth.uid;
      }
      
      function isPackageRunner() {
        return signedIn() && request.auth.token.get('packageRunner', false) == true;
      }
      
      // Allow public read for tracking - anyone can track with tracking number
      allow read: if true; // Public tracking enabled
      
      // Any authenticated user can create a package as sender
      allow create: if signedIn()
        && request.resource.data.senderId == request.auth.uid;
      
      // Package runners and admins can update packages (for status changes)
      allow update: if isPackageRunner() || isAdmin();
      
      // Only admins can delete packages
      allow delete: if isAdmin();
    }

    // ========== FEATURE FLAGS ==========
    match /featureFlags/{doc} {
      // Anyone can read feature flags (needed for UI feature control)
      allow read: if true;
      
      // Only admins can manage feature flags
      allow create, update, delete: if isAdmin();
    }

    // ========== EQUIPMENT SUBMISSIONS ==========
    match /equipmentSubmissions/{submissionId} {
      // Couriers can read their own submissions
      allow read: if signedIn() && resource.data.courierId == request.auth.uid;
      
      // Couriers can create equipment submissions
      allow create: if signedIn() && request.resource.data.courierId == request.auth.uid;
      
      // Only admins can update/delete equipment submissions
      allow update, delete: if isAdmin();
      
      // Admins can read all submissions
      allow read: if isAdmin();
    }
  }
}
