rules_version = '2';

// Firestore Security Rules for GoSender App
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isVendor() {
      return isAuthenticated() && getUserRole() == 'vendor';
    }
    
    function isCustomer() {
      return isAuthenticated() && getUserRole() == 'customer';
    }
    
    function isDeliveryAgent() {
      return isAuthenticated() && getUserRole() == 'delivery_agent';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidUserRole(role) {
      return role in ['customer', 'vendor', 'delivery_agent', 'admin'];
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        isOwner(userId) || 
        isAdmin() ||
        // Allow vendors to read customer info for orders
        (isVendor() && resource.data.role == 'customer') ||
        // Allow delivery agents to read customer/vendor info for deliveries
        (isDeliveryAgent() && resource.data.role in ['customer', 'vendor'])
      );
      
      allow create: if isAuthenticated() && 
        request.auth.uid == userId &&
        isValidUserRole(request.resource.data.role) &&
        request.resource.data.uid == userId;
      
      allow update: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      ) && (
        // Prevent role changes unless admin
        !('role' in request.resource.data.diff(resource.data).changedKeys()) ||
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin()
      );
    }
    
    // Orders collection
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.customerId == request.auth.uid ||
        resource.data.vendorId == request.auth.uid ||
        resource.data.deliveryAgentId == request.auth.uid
      );
      
      allow create: if isAuthenticated() && 
        request.resource.data.customerId == request.auth.uid &&
        isCustomer();
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        // Customers can update before confirmation
        (resource.data.customerId == request.auth.uid && isCustomer() && resource.data.status == 'pending') ||
        // Vendors can update order status
        (resource.data.vendorId == request.auth.uid && isVendor()) ||
        // Delivery agents can update delivery status
        (resource.data.deliveryAgentId == request.auth.uid && isDeliveryAgent())
      );
      
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.customerId == request.auth.uid && isCustomer() && resource.data.status == 'pending')
      );
    }
    
    // Products collection
    match /products/{productId} {
      allow read: if true; // Public read access for browsing
      
      allow create: if isAuthenticated() && 
        isVendor() &&
        request.resource.data.vendorId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.vendorId == request.auth.uid && isVendor())
      );
      
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.vendorId == request.auth.uid && isVendor())
      );
    }
    
    // Vendors collection
    match /vendors/{vendorId} {
      allow read: if true; // Public read access for browsing
      
      allow create: if isAuthenticated() && 
        isVendor() &&
        request.auth.uid == vendorId;
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isOwner(vendorId) && isVendor())
      );
      
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isOwner(vendorId)
      );
    }
    
    // Delivery Agents collection
    match /delivery_agents/{agentId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isOwner(agentId) ||
        // Vendors can see available delivery agents
        isVendor()
      );
      
      allow create: if isAuthenticated() && 
        isDeliveryAgent() &&
        request.auth.uid == agentId;
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isOwner(agentId) && isDeliveryAgent())
      );
      
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isOwner(agentId)
      );
    }
    
    // Categories collection
    match /categories/{categoryId} {
      allow read: if true; // Public read access
      
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if true; // Public read access
      
      allow create: if isAuthenticated() && 
        request.resource.data.reviewerId == request.auth.uid &&
        isCustomer();
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.reviewerId == request.auth.uid && isCustomer())
      );
      
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.reviewerId == request.auth.uid
      );
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() && isAdmin();
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        // Users can mark notifications as read
        (resource.data.userId == request.auth.uid && 
         request.resource.data.diff(resource.data).changedKeys().hasOnly(['isRead', 'updatedAt']))
      );
      
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // Chat/Messages collection (if implemented)
    match /chats/{chatId} {
      allow read, write: if isAuthenticated() && (
        isAdmin() ||
        request.auth.uid in resource.data.participants
      );
    }
    
    // Default deny rule for any other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Firebase Storage Security Rules
service firebase.storage {
  match /b/{bucket}/o {
    
    // Profile images
    match /profile_images/{userId}/{allPaths=**} {
      allow read: if true; // Public read access for profile images
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Product images
    match /product_images/{vendorId}/{allPaths=**} {
      allow read: if true; // Public read access for product images
      allow write: if request.auth != null && 
        request.auth.uid == vendorId &&
        request.resource.size < 5 * 1024 * 1024; // 5MB limit
    }
    
    // Vendor logos
    match /vendor_logos/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if request.auth != null &&
        request.resource.size < 2 * 1024 * 1024; // 2MB limit
    }
    
    // Delivery proof images
    match /delivery_proofs/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        request.resource.size < 10 * 1024 * 1024; // 10MB limit
    }
    
    // Default deny rule
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}